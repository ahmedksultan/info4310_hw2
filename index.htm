<html>
    <head>
        <title>INFO 4310 - HW2</title>

        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://d3js.org/topojson.v2.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

        <style>
            .header {
                text-align: center;
                font-family: "Helvetica";
            }

            .page-title {
                font-size: 72px;
                padding-top: 0.5em;
                margin: 0;
            }

            svg {
                padding-left: 5vw;
            }

            .container {
                display: flex;
                flex-direction: row;
            }

            h2 {
                font-family: "Helvetica";
                text-align: center;
            }
        </style>
    </head>

    <body>
        <div class="header">
            <h1 class="page-title">EVs in Washington</h1>
            <p>prepared by Ahmed Sultan (aks264) and Sydney Wan (ssw73), for Professor Rzeszotarski's INFO 4310 class</p>
        </div>

        <div class="container">
            <div>
                <h2>Blah blah blah</h2>
                <svg id="choropleth" height="500" width="900"></svg>
            </div>
        </div>

        <script>
            

            const requestData = async function() {
                const counties = await d3.json("data/wa_county_boundaries_2.geojson");
                const county_EVs = await d3.json("data/ev_data_short.json");

                // SVG A : CHOROPLETH MAP
                let svg_a = d3.select("#choropleth")
                            //   .call(d3.zoom().on("zoom", function () {
                            //     svg_a.attr("transform", d3.event.transform);
                            //   }));
                let width_a = svg_a.attr("width");
                let height_a = svg_a.attr("height");

                let margin = {
                    top: 10, bottom: 10, right: 10, left: 10
                }

                let mapWidth = width_a - margin.left - margin.right;
                let mapHeight = height_a - margin.top - margin.bottom;

                let map = svg_a.append("g")
                                .attr("transform", "translate("+margin.left+","+margin.top+")");

                // geojson stuff 
                let projection = d3.geoIdentity()
                    .reflectY(true)
                    .fitSize([mapWidth - 100, mapHeight - 150], counties);
                let path = d3.geoPath().projection(projection);

                // for scales and reference
                statewide = {
                    "totals": [],
                    "makes": [],
                    "years": [], 
                    // "ranges" : [],
                    "types": [],
                    "clean_el": []
                }

                // adding county-specific data from EV dataset
                counties.features.forEach( c => { 
                    target_name = c.properties["NAME"];
                    target = county_EVs[target_name];

                    // appending to geojson feature property info
                    c.properties["total"] = target["total"];
                    c.properties["makes"] = target["makes"];
                    // maybe later its a lot of # for no rzn
                    // c.properties["ranges"] = target["ranges"]
                    c.properties["years"] = target["years"];
                    c.properties["types"] = target["types"];
                    c.properties["clean_el"] = target["clean_eligibilities"];

                    // adding to state-wide data
                    statewide["totals"].push(target["total"]);
                });

                // double checking
                console.log(counties.features);
                console.log(county_EVs);

                // some quick scale stuff
                const minmax = d3.extent(Object.values(statewide["totals"]));
                console.log(minmax);

                let colorScale = d3.scaleQuantize()
                    .domain(minmax)
                    .range(d3.schemeBlues[5]);

                map.selectAll("path.county").data(counties.features)
                    .join("path")
                    .attr("class", "county")
                    .attr("d", path)
                    .style('transform', 'scaleY(1.4)')
                    .style("stroke", "white") 
                    .style("stroke-width", 0.5)
                    .style("fill", d => colorScale( d.properties.total ));

                // attempt to implement zoom feature
                var zoom = d3.zoom()
                  .scaleExtent([1,20])
                  .translateExtent([[-50,-50],[mapWidth+50,mapHeight+50]])  // to lock to edges
                  .on("zoom", mapZoomed);

                svg_a.call(zoom);

                // //Plotting EV Stations
                stations = await d3.csv("data/alt_fuel_stations.csv", d3.autoType);

                stations.forEach( d => {
                    d.Position = projection( [d.Longitude, d.Latitude] );          
                });

                let circles = map.selectAll("circle").data(stations)
                                .join("circle")
                                .attr("r", 3)
                                .attr("fill", "green")
                                .attr("opacity", 0.7)
                                .attr("cx", d => d.Position[0])
                                .attr("cy", d => d.Position[1]);

                

                function mapZoomed() {      
                     map.attr("transform", d3.event.transform);
                     circles.attr("r", 3 / d3.event.transform.k);
                }
            }
            requestData();
        </script>
    </body>
</html>